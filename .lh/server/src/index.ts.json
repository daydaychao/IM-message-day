{
    "sourceFile": "server/src/index.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1763700605726,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763700614705,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,10 +9,9 @@\n   MessagePayload,\n   TypingPayload,\n   ReadPayload,\n   CreateGroupPayload,\n-  Message, host:\n-  \n+  Message,\n   ConnectedClient\n } from './types'\n \n const PORT = 8080\n"
                },
                {
                    "date": 1763712573487,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,10 +18,21 @@\n \n // Initialize Redis connection\n connectRedis()\n   .then(() => {\n-    console.log('Redis connected successfully')\n-    startServer()\n+    console.log(\"Redis connected successfully\");\n+\n+    // 測試 Redis\n+    const pong = await redisClient.ping();\n+    console.log(\"Redis PING response:\", pong); // 應該是 \"PONG\"\n+\n+    // 測試寫入和讀取\n+    await redisClient.set(\"test\", \"hello\");\n+    const value = await redisClient.get(\"test\");\n+    console.log(\"Test value:\", value); // 應該是 \"hello\"\n+\n+    \n+    startServer();\n   })\n   .catch((err) => {\n     console.error('Failed to connect to Redis:', err)\n     console.log('Please make sure Redis is running on localhost:6379')\n@@ -406,9 +417,9 @@\n \n   async function broadcastUserList() {\n     const connectedClients = await store.getAllConnectedClients()\n     const allUsers = await store.getAllUsers()\n-    const usersWithStatus = []\n+    const usersWithStatus: Array<{id: string, username: string, isOnline: boolean}> = []\n \n     for (const u of allUsers) {\n       const client = await store.getConnectedClient(u.id)\n       usersWithStatus.push({\n"
                },
                {
                    "date": 1763712602812,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,9 +17,9 @@\n const PORT = 8080\n \n // Initialize Redis connection\n connectRedis()\n-  .then(() => {\n+  .then(async () => {\n     console.log(\"Redis connected successfully\");\n \n     // 測試 Redis\n     const pong = await redisClient.ping();\n@@ -29,16 +29,15 @@\n     await redisClient.set(\"test\", \"hello\");\n     const value = await redisClient.get(\"test\");\n     console.log(\"Test value:\", value); // 應該是 \"hello\"\n \n-    \n     startServer();\n   })\n   .catch((err) => {\n-    console.error('Failed to connect to Redis:', err)\n-    console.log('Please make sure Redis is running on localhost:6379')\n-    process.exit(1)\n-  })\n+    console.error(\"Failed to connect to Redis:\", err);\n+    console.log(\"Please make sure Redis is running on localhost:6379\");\n+    process.exit(1);\n+  });\n \n function startServer() {\n   const wss = new WebSocketServer({ port: PORT })\n   console.log(`WebSocket server started on port ${PORT}`)\n"
                },
                {
                    "date": 1763712612474,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -20,17 +20,9 @@\n connectRedis()\n   .then(async () => {\n     console.log(\"Redis connected successfully\");\n \n-    // 測試 Redis\n-    const pong = await redisClient.ping();\n-    console.log(\"Redis PING response:\", pong); // 應該是 \"PONG\"\n \n-    // 測試寫入和讀取\n-    await redisClient.set(\"test\", \"hello\");\n-    const value = await redisClient.get(\"test\");\n-    console.log(\"Test value:\", value); // 應該是 \"hello\"\n-\n     startServer();\n   })\n   .catch((err) => {\n     console.error(\"Failed to connect to Redis:\", err);\n"
                },
                {
                    "date": 1763712632594,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -17,11 +17,19 @@\n const PORT = 8080;\n \n // Initialize Redis connection\n connectRedis()\n-  .then(() => {\n+  .then(async () => {\n     console.log(\"Redis connected successfully\");\n \n+    // 測試 Redis\n+    const pong = await redisClient.ping();\n+    console.log(\"Redis PING response:\", pong); // 應該是 \"PONG\"\n+\n+    // 測試寫入和讀取\n+    await redisClient.set(\"test\", \"hello\");\n+    const value = await redisClient.get(\"test\");\n+    console.log(\"Test value:\", value); // 應該是 \"hello\"\n     startServer();\n   })\n   .catch((err) => {\n     console.error(\"Failed to connect to Redis:\", err);\n"
                },
                {
                    "date": 1763712680872,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,7 @@\n import { WebSocketServer, WebSocket } from \"ws\";\n import { v4 as uuidv4 } from \"uuid\";\n-import { connectRedis } from \"./redis\";\n+import { connectRedis, redisClient } from \"./redis\";\n import { store } from \"./store\";\n import {\n   WSMessage,\n   AuthPayload,\n"
                }
            ],
            "date": 1763700605726,
            "name": "Commit-0",
            "content": "import { WebSocketServer, WebSocket } from 'ws'\nimport { v4 as uuidv4 } from 'uuid'\nimport { connectRedis } from './redis'\nimport { store } from './store'\nimport {\n  WSMessage,\n  AuthPayload,\n  RegisterPayload,\n  MessagePayload,\n  TypingPayload,\n  ReadPayload,\n  CreateGroupPayload,\n  Message, host:\n  \n  ConnectedClient\n} from './types'\n\nconst PORT = 8080\n\n// Initialize Redis connection\nconnectRedis()\n  .then(() => {\n    console.log('Redis connected successfully')\n    startServer()\n  })\n  .catch((err) => {\n    console.error('Failed to connect to Redis:', err)\n    console.log('Please make sure Redis is running on localhost:6379')\n    process.exit(1)\n  })\n\nfunction startServer() {\n  const wss = new WebSocketServer({ port: PORT })\n  console.log(`WebSocket server started on port ${PORT}`)\n\n  // Map to track which userId belongs to which WebSocket\n  const wsToUserId = new WeakMap<WebSocket, string>()\n\n  wss.on('connection', (ws: WebSocket) => {\n    console.log('New client connected')\n\n    ws.on('message', async (data: Buffer) => {\n      try {\n        const message: WSMessage = JSON.parse(data.toString())\n        await handleMessage(ws, message)\n      } catch (error) {\n        console.error('Error parsing message:', error)\n        sendError(ws, 'Invalid message format')\n      }\n    })\n\n    ws.on('close', async () => {\n      try {\n        const userId = wsToUserId.get(ws)\n        if (userId) {\n          await store.removeConnectedClient(userId)\n          console.log(`User ${userId} disconnected`)\n\n          // Notify other users\n          await broadcastUserList()\n        }\n      } catch (error) {\n        console.error('Error handling close:', error)\n      }\n    })\n\n    ws.on('error', (error) => {\n      console.error('WebSocket error:', error)\n    })\n  })\n\n  async function handleMessage(ws: WebSocket, message: WSMessage) {\n    try {\n      switch (message.type) {\n        case 'register':\n          await handleRegister(ws, message.payload as RegisterPayload)\n          break\n        case 'auth':\n          await handleAuth(ws, message.payload as AuthPayload)\n          break\n        case 'message':\n          await handleChatMessage(ws, message.payload as MessagePayload)\n          break\n        case 'typing':\n          await handleTyping(ws, message.payload as TypingPayload)\n          break\n        case 'read':\n          await handleRead(ws, message.payload as ReadPayload)\n          break\n        case 'create_group':\n          await handleCreateGroup(ws, message.payload as CreateGroupPayload)\n          break\n        case 'get_groups':\n          await handleGetGroups(ws)\n          break\n        case 'get_users':\n          await handleGetUsers(ws)\n          break\n        default:\n          sendError(ws, 'Unknown message type')\n      }\n    } catch (error) {\n      console.error('Error handling message:', error)\n      sendError(ws, 'Internal server error')\n    }\n  }\n\n  async function handleRegister(ws: WebSocket, payload: RegisterPayload) {\n    const { username, password } = payload\n\n    console.log(`Registration attempt: username=\"${username}\"`)\n\n    // Check if user already exists\n    const existingUser = await store.getUserByUsername(username)\n    if (existingUser) {\n      console.log(`Username already exists: ${username}`)\n      sendError(ws, 'Username already exists')\n      return\n    }\n\n    // Create new user\n    const userId = uuidv4()\n    await store.createUser({\n      id: userId,\n      username,\n      password\n    })\n\n    // Store connection (auto-login after registration)\n    wsToUserId.set(ws, userId)\n    await store.addConnectedClient({\n      userId: userId,\n      username: username,\n      ws\n    })\n\n    console.log(`User registered successfully: ${username}`)\n    const allUsers = await store.getAllUsers()\n    console.log(`Total users in database: ${allUsers.length}`)\n\n    send(ws, {\n      type: 'register_success',\n      payload: {\n        userId,\n        username\n      }\n    })\n\n    // Broadcast updated user list\n    await broadcastUserList()\n  }\n\n  async function handleAuth(ws: WebSocket, payload: AuthPayload) {\n    const { username, password } = payload\n\n    console.log(`Login attempt: username=\"${username}\"`)\n    const user = await store.getUserByUsername(username)\n\n    if (!user) {\n      console.log(`User not found: ${username}`)\n      sendError(ws, 'Invalid credentials')\n      return\n    }\n\n    if (user.password !== password) {\n      console.log(`Incorrect password for user: ${username}`)\n      sendError(ws, 'Invalid credentials')\n      return\n    }\n\n    // Store connection\n    wsToUserId.set(ws, user.id)\n    await store.addConnectedClient({\n      userId: user.id,\n      username: user.username,\n      ws\n    })\n\n    console.log(`User authenticated: ${username}`)\n\n    // Send success response\n    send(ws, {\n      type: 'auth_success',\n      payload: {\n        userId: user.id,\n        username: user.username\n      }\n    })\n\n    // Send user groups\n    const groups = await store.getUserGroups(user.id)\n    send(ws, {\n      type: 'groups_list',\n      payload: { groups }\n    })\n\n    // Broadcast updated user list\n    await broadcastUserList()\n  }\n\n  async function handleChatMessage(ws: WebSocket, payload: MessagePayload) {\n    const userId = wsToUserId.get(ws)\n    if (!userId) {\n      sendError(ws, 'Not authenticated')\n      return\n    }\n\n    const user = await store.getUserById(userId)\n    if (!user) return\n\n    const messageId = uuidv4()\n    const isGroup = !!payload.groupId\n    const conversationId = payload.groupId || payload.recipientId || ''\n\n    const message: Message = {\n      id: messageId,\n      senderId: userId,\n      senderName: user.username,\n      content: payload.content,\n      type: payload.type,\n      timestamp: Date.now(),\n      status: 'sent',\n      conversationId,\n      isGroup\n    }\n\n    await store.addMessage(message)\n\n    // Send confirmation to sender\n    send(ws, {\n      type: 'message_sent',\n      payload: { message }\n    })\n\n    // Deliver to recipients\n    if (isGroup) {\n      // Group message\n      const group = await store.getGroupById(conversationId)\n      if (group) {\n        for (const memberId of group.members) {\n          if (memberId !== userId) {\n            const client = await store.getConnectedClient(memberId)\n            if (client) {\n              send(client.ws, {\n                type: 'message_received',\n                payload: { message }\n              })\n              // Update to delivered\n              await store.updateMessageStatus(messageId, 'delivered')\n            }\n          }\n        }\n      }\n    } else {\n      // DM\n      const recipient = await store.getConnectedClient(conversationId)\n      if (recipient) {\n        send(recipient.ws, {\n          type: 'message_received',\n          payload: { message }\n        })\n        // Update to delivered\n        await store.updateMessageStatus(messageId, 'delivered')\n\n        // Notify sender of delivery\n        send(ws, {\n          type: 'message_delivered',\n          payload: { messageId }\n        })\n      }\n    }\n  }\n\n  async function handleTyping(ws: WebSocket, payload: TypingPayload) {\n    const userId = wsToUserId.get(ws)\n    if (!userId) return\n\n    const user = await store.getUserById(userId)\n    if (!user) return\n\n    if (payload.groupId) {\n      // Broadcast to group\n      const group = await store.getGroupById(payload.groupId)\n      if (group) {\n        for (const memberId of group.members) {\n          if (memberId !== userId) {\n            const client = await store.getConnectedClient(memberId)\n            if (client) {\n              send(client.ws, {\n                type: 'user_typing',\n                payload: {\n                  userId,\n                  username: user.username,\n                  groupId: payload.groupId,\n                  isTyping: payload.isTyping\n                }\n              })\n            }\n          }\n        }\n      }\n    } else if (payload.recipientId) {\n      // Send to specific user\n      const recipient = await store.getConnectedClient(payload.recipientId)\n      if (recipient) {\n        send(recipient.ws, {\n          type: 'user_typing',\n          payload: {\n            userId,\n            username: user.username,\n            isTyping: payload.isTyping\n          }\n        })\n      }\n    }\n  }\n\n  async function handleRead(ws: WebSocket, payload: ReadPayload) {\n    const userId = wsToUserId.get(ws)\n    if (!userId) return\n\n    const message = await store.getMessageById(payload.messageId)\n    if (!message) return\n\n    await store.updateMessageStatus(payload.messageId, 'read')\n\n    // Notify sender\n    const sender = await store.getConnectedClient(message.senderId)\n    if (sender) {\n      send(sender.ws, {\n        type: 'message_read',\n        payload: { messageId: payload.messageId }\n      })\n    }\n  }\n\n  async function handleCreateGroup(ws: WebSocket, payload: CreateGroupPayload) {\n    const userId = wsToUserId.get(ws)\n    if (!userId) {\n      sendError(ws, 'Not authenticated')\n      return\n    }\n\n    const groupId = uuidv4()\n    const group = {\n      id: groupId,\n      name: payload.name,\n      members: [userId, ...payload.memberIds],\n      createdBy: userId,\n      createdAt: Date.now()\n    }\n\n    await store.createGroup(group)\n\n    // Notify all members\n    for (const memberId of group.members) {\n      const client = await store.getConnectedClient(memberId)\n      if (client) {\n        send(client.ws, {\n          type: 'group_created',\n          payload: { group }\n        })\n      }\n    }\n\n    console.log(`Group created: ${payload.name}`)\n  }\n\n  async function handleGetGroups(ws: WebSocket) {\n    const userId = wsToUserId.get(ws)\n    if (!userId) {\n      sendError(ws, 'Not authenticated')\n      return\n    }\n\n    const groups = await store.getUserGroups(userId)\n    send(ws, {\n      type: 'groups_list',\n      payload: { groups }\n    })\n  }\n\n  async function handleGetUsers(ws: WebSocket) {\n    const userId = wsToUserId.get(ws)\n    if (!userId) {\n      sendError(ws, 'Not authenticated')\n      return\n    }\n\n    const allUsers = await store.getAllUsers()\n    const usersWithStatus = []\n\n    for (const u of allUsers) {\n      const client = await store.getConnectedClient(u.id)\n      usersWithStatus.push({\n        id: u.id,\n        username: u.username,\n        isOnline: !!client\n      })\n    }\n\n    send(ws, {\n      type: 'users_list',\n      payload: { users: usersWithStatus }\n    })\n  }\n\n  async function broadcastUserList() {\n    const connectedClients = await store.getAllConnectedClients()\n    const allUsers = await store.getAllUsers()\n    const usersWithStatus = []\n\n    for (const u of allUsers) {\n      const client = await store.getConnectedClient(u.id)\n      usersWithStatus.push({\n        id: u.id,\n        username: u.username,\n        isOnline: !!client\n      })\n    }\n\n    connectedClients.forEach(client => {\n      send(client.ws, {\n        type: 'users_list',\n        payload: { users: usersWithStatus }\n      })\n    })\n  }\n\n  function send(ws: WebSocket, message: any) {\n    if (ws.readyState === WebSocket.OPEN) {\n      ws.send(JSON.stringify(message))\n    }\n  }\n\n  function sendError(ws: WebSocket, error: string) {\n    send(ws, {\n      type: 'error',\n      payload: { error }\n    })\n  }\n}\n"
        }
    ]
}