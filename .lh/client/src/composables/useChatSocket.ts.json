{
    "sourceFile": "client/src/composables/useChatSocket.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763483153279,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763483268684,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -56,8 +56,9 @@\n     }\n   }\n \n   function send(message: any) {\n+    console.log('message',message)\n     if (ws.value && ws.value.readyState === WebSocket.OPEN) {\n       ws.value.send(JSON.stringify(message));\n     } else {\n       console.error(\"WebSocket is not connected\");\n"
                },
                {
                    "date": 1763483298003,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -57,8 +57,9 @@\n   }\n \n   function send(message: any) {\n     console.log(\"message\", message);\n+    console.log(\"ws.value.readyState\", ws.value.readyState);\n     if (ws.value && ws.value.readyState === WebSocket.OPEN) {\n       ws.value.send(JSON.stringify(message));\n     } else {\n       console.error(\"WebSocket is not connected\");\n"
                }
            ],
            "date": 1763483153279,
            "name": "Commit-0",
            "content": "import { ref } from 'vue'\nimport { useAuthStore } from '../stores/auth'\nimport { useChatStore } from '../stores/chat'\nimport type { Message, Group } from '../types'\n\nconst WS_URL = 'ws://localhost:8080'\n\nexport function useChatSocket() {\n  const ws = ref<WebSocket | null>(null)\n  const isConnected = ref(false)\n  const authStore = useAuthStore()\n  const chatStore = useChatStore()\n\n  function connect() {\n    if (ws.value) return\n\n    ws.value = new WebSocket(WS_URL)\n\n    ws.value.onopen = () => {\n      console.log('WebSocket connected')\n      isConnected.value = true\n      chatStore()\n    }\n\n    ws.value.onmessage = (event) => {\n      try {\n        const message = JSON.parse(event.data)\n        handleMessage(message)\n      } catch (error) {\n        console.error('Error parsing message:', error)\n      }\n    }\n\n    ws.value.onerror = (error) => {\n      console.error('WebSocket error:', error)\n    }\n\n    ws.value.onclose = () => {\n      console.log('WebSocket disconnected')\n      isConnected.value = false\n      ws.value = null\n\n      // Auto reconnect after 3 seconds\n      setTimeout(() => {\n        if (authStore.isAuthenticated) {\n          connect()\n        }\n      }, 3000)\n    }\n  }\n\n  function disconnect() {\n    if (ws.value) {\n      ws.value.close()\n      ws.value = null\n      isConnected.value = false\n    }\n  }\n\n  function send(message: any) {\n    if (ws.value && ws.value.readyState === WebSocket.OPEN) {\n      ws.value.send(JSON.stringify(message))\n    } else {\n      console.error('WebSocket is not connected')\n    }\n  }\n\n  function register(username: string, password: string) {\n    send({\n      type: 'register',\n      payload: { username, password }\n    })\n  }\n\n  function login(username: string, password: string) {\n    send({\n      type: 'auth',\n      payload: { username, password }\n    })\n  }\n\n  function sendMessage(recipientId: string | undefined, groupId: string | undefined, content: string, type: 'text' | 'image' = 'text') {\n    send({\n      type: 'message',\n      payload: {\n        recipientId,\n        groupId,\n        content,\n        type\n      }\n    })\n  }\n\n  function sendTyping(recipientId: string | undefined, groupId: string | undefined, isTyping: boolean) {\n    send({\n      type: 'typing',\n      payload: {\n        recipientId,\n        groupId,\n        isTyping\n      }\n    })\n  }\n\n  function markAsRead(messageId: string) {\n    send({\n      type: 'read',\n      payload: { messageId }\n    })\n  }\n\n  function createGroup(name: string, memberIds: string[]) {\n    send({\n      type: 'create_group',\n      payload: { name, memberIds }\n    })\n  }\n\n  function getUsers() {\n    send({\n      type: 'get_users',\n      payload: {}\n    })\n  }\n\n  function getGroups() {\n    send({\n      type: 'get_groups',\n      payload: {}\n    })\n  }\n\n  function handleMessage(message: any) {\n    switch (message.type) {\n      case 'register_success':\n        console.log('Registration successful:', message.payload)\n        // Auto login after registration\n        authStore.setUser(message.payload.userId, message.payload.username)\n        chatStore.setUserId(message.payload.userId)\n        getUsers()\n        getGroups()\n        break\n\n      case 'auth_success':\n        console.log('Authentication successful:', message.payload)\n        authStore.setUser(message.payload.userId, message.payload.username)\n        chatStore.setUserId(message.payload.userId)\n        getUsers()\n        getGroups()\n        break\n\n      case 'users_list':\n        chatStore.setUsers(message.payload.users)\n        break\n\n      case 'groups_list':\n        chatStore.setGroups(message.payload.groups)\n        break\n\n      case 'message_sent':\n      case 'message_received':\n        chatStore.addMessage(message.payload.message as Message)\n        break\n\n      case 'message_delivered':\n        chatStore.updateMessageStatus(message.payload.messageId, 'delivered')\n        break\n\n      case 'message_read':\n        chatStore.updateMessageStatus(message.payload.messageId, 'read')\n        break\n\n      case 'user_typing':\n        const conversationId = message.payload.groupId || message.payload.userId\n        chatStore.setTyping({\n          userId: message.payload.userId,\n          username: message.payload.username,\n          conversationId,\n          isTyping: message.payload.isTyping\n        })\n        break\n\n      case 'group_created':\n        chatStore.addGroup(message.payload.group as Group)\n        break\n\n      case 'error':\n        console.error('Server error:', message.payload.error)\n        alert(`Error: ${message.payload.error}`)\n        break\n\n      default:\n        console.log('Unknown message type:', message.type)\n    }\n  }\n\n  return {\n    ws,\n    isConnected,\n    connect,\n    disconnect,\n    register,\n    login,\n    sendMessage,\n    sendTyping,\n    markAsRead,\n    createGroup,\n    getUsers,\n    getGroups\n  }\n}\n"
        }
    ]
}